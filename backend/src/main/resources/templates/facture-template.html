<!--<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Facture</title>
    <style>
        @page { size: A4; margin: 22mm 16mm 22mm 16mm; }
        body { font-family: Arial, "Helvetica Neue", Helvetica, sans-serif; font-size: 12px; color:#222; }

        .card { border:1px solid #e5e7eb; border-radius:8px; padding:18px; }
        .center { text-align:center; }
        .right { text-align:right; }
        .muted { color:#666; }

        /* Layout sans flex: colonnes en inline-block */
        .row { font-size:0; }
        .col { display:inline-block; vertical-align:top; font-size:12px; }
        .header .col-left  { width:30%; }
        .header .col-mid   { width:40%; }
        .header .col-right { width:30%; }


        .logo-box { width:120px; height:60px; border:1px solid #999; text-align:center; line-height:60px; color:#666; border-radius:6px; font-size:11px; }

        .title { font-weight:700; font-size:16px; margin:0; }
        .number { font-weight:600; margin:0; }


        .kv-line { margin:0 0 2px 0; }
        .kv-key  { display:inline-block; width:92px; color:#666; }
        .kv-val  { display:inline-block; }


        .twocol { font-size:0; margin-top:8px;}
        .twocol .col { width:50%; }
        .twocol .col.right { padding-left:10px; }


        table.lines { width:100%; border-collapse:collapse; margin-top:10px; }
        .lines th, .lines td { border:1px solid #e5e7eb; padding:8px 10px; vertical-align:top; }
        .lines thead th { background:#f7f7f7; font-weight:600; }
        .w-desc { width:70%; }
        .w-amt { width:30%; text-align:right; }


        .totals { text-align:right; margin-top:10px; }
        .totals-box { display:inline-block; min-width:260px; border:1px solid #e5e7eb; border-radius:8px; padding:12px 14px; background:#fbfbfb; text-align:left; }
        .total-row { overflow:hidden; padding:4px 0; }
        .total-row .label { float:left; }
        .total-row .value { float:right; white-space:nowrap; }
        .grand .label, .grand .value { font-weight:800; font-size:14px; }


        .signatures { font-size:0; margin-top:34px; }
        .sig { display:inline-block; width:48%; text-align:center; font-size:12px; }
        .sig + .sig { margin-left:4%; }
        .sig .label { margin-bottom:36px; }
        .line { border-top:1px solid #222; height:0; margin:0 30px; }

    </style>
</head>
<body>
<div class="card">


    <div class="row header">
        <div class="col col-left">
            <div th:if="${logoSrc != null and !#strings.isEmpty(logoSrc)}">
                <img th:src="${logoSrc}" alt="Logo" style="max-width:120px; max-height:60px;"/>
            </div>
            <div class="logo-box" th:if="${logoSrc == null or #strings.isEmpty(logoSrc)}">LOGO</div>
        </div>

        <div class="col col-mid center">
            <p class="title">FACTURE</p>
            <p class="number">N° <span th:text="${facture.numero}">FAC-XXXX</span></p>
        </div>

        <div class="col col-right right">
            <div class="kv-line">
                <span class="kv-key">Date</span>
                <span class="kv-val" th:text="${facture.dateEmission}">2025-01-01</span>
            </div>

        </div>
    </div>

    <hr/>


    <div class="twocol">
        <div class="col">
            <p style="font-weight:700; margin:0 0 6px 0; font-size:12px; text-transform:uppercase; letter-spacing:.4px;">Patient</p>
            <div style="margin-bottom:6px;" th:text="${facture.patient != null ? facture.patient.nom + ' ' + facture.patient.prenom : ''}">Nom Prénom</div>
            <div class="muted" style="margin-bottom:6px;" th:text="${facture.patient != null ? facture.patient.telephone : ''}">+212…</div>
            <div class="muted" th:text="${facture.patient != null ? facture.patient.adresse : ''}">Adresse</div>
        </div>
        <div class="col right">
            <p style="font-weight:700; margin:0 0 6px 0; font-size:12px; text-transform:uppercase; letter-spacing:.4px;">Médecin</p>
            <div style="margin-bottom:6px;" th:text="${facture.medecin != null ? ('Dr ' + facture.medecin.nom + ' ' + facture.medecin.prenom) : ''}">Dr X</div>
            <div class="muted" style="margin-bottom:6px;">Tel: <span th:text="${facture.medecin != null ? facture.medecin.telephone : ''}">05…</span></div>
            <div class="muted" style="margin-bottom:6px;" th:text="${facture.medecin != null ? facture.medecin.adresse : ''}">Adresse</div>
            <div class="muted">Email: <span th:text="${facture.medecin != null ? facture.medecin.email : ''}">dr@ex.com</span></div>
        </div>
    </div>


    <table class="lines">
        <thead>
        <tr>
            <th class="w-desc">Description</th>
            <th class="w-amt">Montant (MAD)</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="ligne : ${lignes}">
            <td th:text="${ligne.description}">Consultation</td>
            <td class="w-amt" th:text="${#numbers.formatDecimal(ligne.prix, 1, 'POINT', 2, 'POINT')}">300.00</td>
        </tr>
        <tr th:if="${lignes == null or #lists.isEmpty(lignes)}">
            <td class="muted">—</td>
            <td class="w-amt">0.00</td>
        </tr>
        </tbody>
    </table>


    <div class="totals">
        <div class="totals-box">
            <div class="total-row grand">
                <span class="label">Total</span>
                <span class="value"><span th:text="${#numbers.formatDecimal(facture.montantTotal, 1, 'POINT', 2, 'POINT')}">0.00</span> MAD</span>
            </div>
        </div>
    </div>


    <div th:if="${facture.notes != null and !#strings.isEmpty(facture.notes)}" style="margin-top:10px;">
        <p style="font-weight:700; margin:0 0 6px 0; font-size:12px; text-transform:uppercase; letter-spacing:.4px;">Notes</p>
        <div th:text="${facture.notes}">—</div>
    </div>


    <div class="signatures">
        <div class="sig">
            <div class="label">Cachet Médecin :</div>
            <div class="line"></div>
        </div>
        <div class="sig">
            <div class="label">Signature Patient :</div>
            <div class="line"></div>
        </div>
    </div>

</div>
</body>
</html>-->

<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Facture</title>
    <style>
        @page { size: A4; margin: 22mm 16mm 22mm 16mm; }
        body { font-family: Arial, "Helvetica Neue", Helvetica, sans-serif; font-size: 12px; color:#222; }

        .card { border:1px solid #e5e7eb; border-radius:10px; padding:18px; }
        .center { text-align:center; }
        .right { text-align:right; }
        .muted { color:#666; }

        /* Colonnes compatibles HTML->PDF (pas de flex/float) */
        .row { font-size:0; }
        .col { display:inline-block; vertical-align:top; font-size:12px; }
        .header .col-left  { width:30%; }
        .header .col-mid   { width:40%; }
        .header .col-right { width:30%; }

        /* Logo */
        .logo-box { width:120px; height:60px; border:1px solid #e5e7eb; text-align:center; line-height:60px; color:#666; border-radius:6px; font-size:11px; }

        .title  { font-weight:700; font-size:16px; margin:0; }
        .number { font-weight:600; margin:0; }

        .kv-line { margin:0 0 2px 0; }
        .kv-key  { display:inline-block; width:92px; color:#666; }
        .kv-val  { display:inline-block; }

        /* Bloc identités */
        .id-grid { font-size:0; margin-top:12px; }
        .id-col  { display:inline-block; width:50%; font-size:12px; }
        .id-card {
            border:1px solid #e5e7eb; border-radius:8px; padding:10px 12px; background:#fbfbfb;
            word-break: break-word; overflow-wrap: anywhere;
        }
        .id-title {
            font-weight:700; margin:0 0 8px 0; font-size:12px; text-transform:uppercase; letter-spacing:.4px;
        }
        .id-line { margin:0 0 4px 0; }
        .id-key  { display:inline-block; min-width:80px; color:#666; }
        .id-val  { display:inline-block; }

        /* Tableau lignes */
        table.lines { width:100%; border-collapse:collapse; margin-top:12px; table-layout:fixed; }
        .lines th, .lines td { border:1px solid #e5e7eb; padding:8px 10px; vertical-align:top; }
        .lines thead th { background:#f7f7f7; font-weight:600; }
        .w-desc { width:70%; }
        .w-amt  { width:30%; text-align:right; white-space:nowrap; }
        tfoot td { font-weight:800; background:#fafafa; }

        /* Signatures */
        .signatures { font-size:0; margin-top:28px; clear:both; }
        .sig { display:inline-block; width:48%; text-align:center; font-size:12px; }
        .sig + .sig { margin-left:4%; }
        .sig .label { margin-bottom:32px; }
        .line { border-top:1px solid #222; height:0; margin:0 30px; }

        /* Sécurise le rendu PDF */
        .avoid-break { page-break-inside: avoid; }
    </style>
</head>
<body>
<div class="card"
     th:with="
        pNom=${facture?.patient?.nom}, pPre=${facture?.patient?.prenom},
        pTel=${facture?.patient?.telephone}, pAdr=${facture?.patient?.adresse},
        mNom=${facture?.medecin?.nom}, mPre=${facture?.medecin?.prenom},
        mTel=${facture?.medecin?.telephone}, mAdr=${facture?.medecin?.adresse}, mMail=${facture?.medecin?.email}
     ">

    <!-- En-tête -->
    <div class="row header avoid-break">
        <div class="col col-left">
            <div th:if="${logoSrc != null and !#strings.isEmpty(logoSrc)}">
                <img th:src="${logoSrc}" alt="Logo" style="max-width:120px; max-height:60px;"/>
            </div>
            <div class="logo-box" th:if="${logoSrc == null or #strings.isEmpty(logoSrc)}">LOGO</div>
        </div>

        <div class="col col-mid center">
            <p class="title">FACTURE</p>
            <p class="number">N° <span th:text="${facture?.numero}">FAC-XXXX</span></p>
        </div>

        <div class="col col-right right">
            <div class="kv-line">
                <span class="kv-key">Date</span>
                <span class="kv-val"
                      th:text="${facture?.dateEmission != null ? #temporals.format(facture.dateEmission, 'yyyy-MM-dd') : '—'}">
          2025-01-01
        </span>
            </div>
        </div>
    </div>

    <hr class="avoid-break"/>

    <!-- Identités -->
    <div class="id-grid avoid-break">
        <div class="id-col">
            <div class="id-card">
                <p class="id-title">Patient</p>
                <p class="id-line"><span class="id-key">Nom</span>
                    <span class="id-val"
                          th:text="${(pNom != null or pPre != null) ? ((pNom?:'') + ' ' + (pPre?:'')).trim() : '—'}">Nom Prénom</span></p>
                <p class="id-line"><span class="id-key">Téléphone</span>
                    <span class="id-val" th:text="${pTel ?: '—'}">+212…</span></p>
                <p class="id-line"><span class="id-key">Adresse</span>
                    <span class="id-val" th:text="${pAdr ?: '—'}">Adresse</span></p>
            </div>
        </div>

        <div class="id-col">
            <div class="id-card">
                <p class="id-title">Médecin</p>
                <p class="id-line"><span class="id-key">Nom</span>
                    <span class="id-val"
                          th:text="${(mNom != null or mPre != null) ? (('Dr ' + (mNom?:'')) + ' ' + (mPre?:'')).trim() : '—'}">Dr X</span></p>
                <p class="id-line"><span class="id-key">Téléphone</span>
                    <span class="id-val" th:text="${mTel ?: '—'}">05…</span></p>
                <p class="id-line"><span class="id-key">Adresse</span>
                    <span class="id-val" th:text="${mAdr ?: '—'}">Adresse</span></p>
                <p class="id-line"><span class="id-key">Email</span>
                    <span class="id-val" th:text="${mMail ?: '—'}">dr@ex.com</span></p>
            </div>
        </div>
    </div>

    <!-- Lignes + TOTAL dans le tableau -->
    <table class="lines avoid-break">
        <thead>
        <tr>
            <th class="w-desc">Description</th>
            <th class="w-amt">Montant (MAD)</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="ligne : ${lignes}">
            <td th:text="${ligne?.description ?: '—'}">Consultation</td>
            <td class="w-amt"
                th:text="${ligne?.prix != null ? #numbers.formatDecimal(ligne.prix, 1, 'POINT', 2, 'POINT') : '0.00'}">
                300.00
            </td>
        </tr>
        <tr th:if="${lignes == null or #lists.isEmpty(lignes)}">
            <td class="muted">—</td>
            <td class="w-amt">0.00</td>
        </tr>
        </tbody>

        <!-- IMPORTANT: total dans tfoot (rend fiable l’affichage) -->
        <tfoot>
        <tr>
            <td class="right" style="font-weight:800;">Total</td>
            <td class="w-amt"
                th:text="${facture?.montantTotal != null ?
                   #numbers.formatDecimal(facture.montantTotal, 1, 'POINT', 2, 'POINT')
                   : '0.00'}">
                0.00
            </td>
        </tr>
        </tfoot>
    </table>

    <!-- Notes -->
    <div th:if="${facture?.notes != null and !#strings.isEmpty(facture.notes)}" class="avoid-break" style="margin-top:12px;">
        <p class="id-title" style="text-transform:uppercase;">Notes</p>
        <div th:text="${facture.notes}">—</div>
    </div>

    <!-- Signatures -->
    <div class="signatures avoid-break">
        <div class="sig">
            <div class="label">Cachet Médecin :</div>
            <div class="line"></div>
        </div>
        <div class="sig">
            <div class="label">Signature Patient :</div>
            <div class="line"></div>
        </div>
    </div>

</div>
</body>
</html>
